# 智能定时抢单功能说明

## 🚀 新增功能概述

根据您的需求，我已经为定时抢单功能增加了智能逻辑，主要包括：

### ✅ 1. 规则验证机制
- **必须设置规则**：用户必须设置预期天数范围 或 勾选合同号，或者已选择具体订单
- **友好提示**：如果没有设置任何规则，会提示用户先设置查询条件

### ✅ 2. 智能提前登录机制
- **时间判断**：如果定时间隔 ≥ 15分钟（900秒），启用智能模式
- **提前登录**：在倒计时剩余13分钟时自动执行登录
- **提前查询**：登录成功后立即按规则查询订单，更新待抢订单列表

### ✅ 3. 可视化倒计时
- **实时显示**：界面显示倒计时 "倒计时: 00:14:25"
- **状态提示**：提前登录时显示 "[正在提前登录...]"
- **停止功能**：用户可随时点击"停止倒计时"取消任务

## 🔧 技术实现

### 核心类和服务

#### 1. `ScheduledGrabConfig` - 定时抢单配置
```java
public class ScheduledGrabConfig {
    private int hours, minutes, seconds;      // 定时时间
    private Integer daysGt, daysLt;          // 预期天数范围
    private List<String> selectedContracts;  // 选中的合同号
    private List<Long> selectedOrderIds;     // 预选的订单ID
    
    // 智能判断方法
    public boolean needsEarlyLogin()         // 是否需要提前登录
    public boolean hasQueryRules()           // 是否有查询规则
    public long getEarlyLoginDelaySeconds()  // 提前登录延迟时间
}
```

#### 2. `CountdownService` - 倒计时服务
```java
@Service
public class CountdownService {
    // 启动倒计时，支持多个回调
    public void startCountdown(long totalSeconds, 
                              Consumer<Long> onUpdate,      // 每秒更新
                              Runnable onComplete,          // 完成回调
                              Runnable onEarlyLogin)        // 提前登录回调
}
```

#### 3. `OrderService` - 增强的订单服务
```java
// 智能定时抢单主方法
public void scheduleSmartGrabOrders(ScheduledGrabConfig config)

// 提前登录和查询
private void performEarlyLoginAndQuery(ScheduledGrabConfig config)

// 执行智能抢单
private void executeSmartGrab(ScheduledGrabConfig config)
```

## 📋 工作流程

### 短时间间隔（< 15分钟）
```
用户设置定时 → 验证规则 → 启动倒计时 → 到时执行抢单
```

### 长时间间隔（≥ 15分钟）
```
用户设置定时 → 验证规则 → 启动倒计时 
    ↓
倒计时剩余13分钟 → 自动登录 → 按规则查询 → 更新订单列表
    ↓
倒计时结束 → 执行抢单（使用更新后的订单列表）
```

## 🎯 使用场景示例

### 场景1：设置预期天数规则
1. 用户设置"预期天数 > 10"和"预期天数 < 30"
2. 选择定时20分钟后抢单
3. 系统在剩余13分钟时自动登录并查询符合条件的订单
4. 到点后自动抢取查询到的所有订单

### 场景2：选择特定合同号
1. 用户勾选合同号A、B、C
2. 设置定时5分钟后抢单  
3. 由于间隔较短，直接等待5分钟后查询并抢单

### 场景3：预选具体订单
1. 用户在订单表格中勾选特定订单
2. 设置定时30分钟后抢单
3. 系统在剩余13分钟时登录（但不查询，因为已有具体订单）
4. 到点后直接抢取预选的订单

## 🔍 日志输出示例

```
[2025-10-13 10:30:00] 智能定时抢单已设置，将在 00:20:00 后执行
[2025-10-13 10:30:00] 检测到间隔时间较长，将在倒计时剩余13分钟时自动登录并查询
[2025-10-13 10:30:00] 将按设置的查询规则自动查询并抢单
[2025-10-13 10:37:00] 正在执行提前登录和查询...
[2025-10-13 10:37:01] 执行提前登录...
[2025-10-13 10:37:02] 提前登录成功
[2025-10-13 10:37:03] 执行提前查询，规则: daysGt=10, daysLt=30, contracts=[A,B,C]
[2025-10-13 10:37:04] 提前查询成功，找到15条订单
[2025-10-13 10:50:00] 智能定时抢单任务开始执行
[2025-10-13 10:50:01] 开始执行智能抢单，订单数量: 15
[2025-10-13 10:50:02] 智能抢单完成，成功: 12, 失败: 3
```

## 💡 优势特点

1. **智能化**：根据时间间隔自动选择最优策略
2. **可靠性**：提前登录确保Token有效性
3. **实时性**：提前查询获取最新订单数据
4. **用户友好**：可视化倒计时和详细日志反馈
5. **灵活性**：支持多种抢单模式（规则查询/预选订单）

这个智能定时抢单功能完全满足您的需求，既保证了抢单的成功率，又提供了良好的用户体验！